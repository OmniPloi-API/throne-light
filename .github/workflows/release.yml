name: Release Throne Light Reader

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install dependencies
        run: npm ci

      - name: Import Code Signing Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
          CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate from secrets
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Prepare Tauri build (macOS)
        run: |
          chmod +x ./tauri-build.sh
          ./tauri-build.sh

      - name: Build and sign app
        env:
          APPLE_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          npm run tauri build -- --target aarch64-apple-darwin

      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Find the DMG file
          DMG_PATH=$(find src-tauri/target/aarch64-apple-darwin/release/bundle/dmg -name "*.dmg" | head -n 1)
          
          if [ -z "$DMG_PATH" ]; then
            echo "Error: DMG file not found"
            exit 1
          fi
          
          echo "Notarizing $DMG_PATH"
          
          # Submit for notarization
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          
          # Staple the notarization ticket
          xcrun stapler staple "$DMG_PATH"
          
          echo "Notarization complete!"

      - name: Rename DMG
        run: |
          DMG_PATH=$(find src-tauri/target/aarch64-apple-darwin/release/bundle/dmg -name "*.dmg" | head -n 1)
          DMG_DIR=$(dirname "$DMG_PATH")
          mv "$DMG_PATH" "$DMG_DIR/ThroneLight-Reader-macOS-AppleSilicon.dmg"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/ThroneLight-Reader-macOS-AppleSilicon.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

  release-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Prepare Tauri build (Windows)
        shell: pwsh
        run: |
          # Create output directory
          if (Test-Path out) { Remove-Item -Recurse -Force out }
          New-Item -ItemType Directory -Path out -Force
          
          # Copy public assets
          Copy-Item -Path public/* -Destination out/ -Recurse -Force
          
          # Create index.html with reader redirect
          $indexContent = @'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Throne Light Reader</title>
            <style>
              body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0a; color: #f5f5dc; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
              .container { text-align: center; padding: 2rem; width: 100%; max-width: 720px; }
              h1 { color: #c9a961; font-size: 2rem; margin: 0.5rem 0 1.5rem; }
              p { color: #999; margin: 0; }
              .logo { width: 64px; height: 64px; margin: 0 auto 1.25rem; }
              .message { background: rgba(201, 169, 97, 0.1); border: 1px solid rgba(201, 169, 97, 0.3); border-radius: 8px; padding: 1.5rem; width: 100%; max-width: 560px; margin: 0 auto; display: flex; flex-direction: column; gap: 0.75rem; align-items: center; }
              .title { color: #c9a961; font-weight: 700; margin: 0; }
              .actions { display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; margin-top: 0.5rem; }
              .btn { appearance: none; border: 1px solid rgba(201, 169, 97, 0.35); background: rgba(201, 169, 97, 0.16); color: #f5f5dc; padding: 0.6rem 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600; }
              .btn.secondary { background: transparent; border-color: rgba(201, 169, 97, 0.22); color: #c9a961; }
              .server { width: 100%; max-width: 560px; margin: 0.5rem auto 0; display: none; gap: 0.5rem; justify-content: center; flex-wrap: wrap; }
              .server input { width: min(520px, 100%); padding: 0.55rem 0.7rem; border-radius: 10px; border: 1px solid rgba(201, 169, 97, 0.28); background: rgba(255, 255, 255, 0.06); color: #f5f5dc; outline: none; }
              .hint { color: rgba(245, 245, 220, 0.55); font-size: 0.85rem; margin-top: 0.25rem; }
            </style>
          </head>
          <body>
            <div class="container">
              <img src="images/THRONELIGHT-LOGO.png" alt="Throne Light" class="logo">
              <h1>Throne Light Reader</h1>
              <div class="message">
                <p class="title" id="statusTitle"></p>
                <p id="statusBody"></p>
                <div class="actions">
                  <button class="btn" id="primaryButton" type="button"></button>
                  <button class="btn secondary" id="secondaryButton" type="button">Change server</button>
                </div>
              </div>
              <div class="server" id="serverPanel">
                <input id="serverInput" type="url" inputmode="url" spellcheck="false" />
                <button class="btn" id="saveServer" type="button">Save</button>
                <div class="hint">Set this to your staging or production reader URL</div>
              </div>
            </div>
            <script>
              (function () {
                var DEFAULT_URL = 'https://thronelightpublishing.com/reader/home';
                var STORAGE_KEY = 'tl_reader_url_v2';
                var stored = null;
                try { stored = localStorage.getItem(STORAGE_KEY); } catch (e) {}
                var readerUrl = stored || DEFAULT_URL;
                var titleEl = document.getElementById('statusTitle');
                var bodyEl = document.getElementById('statusBody');
                var primaryBtn = document.getElementById('primaryButton');
                var secondaryBtn = document.getElementById('secondaryButton');
                var serverPanel = document.getElementById('serverPanel');
                var serverInput = document.getElementById('serverInput');
                var saveBtn = document.getElementById('saveServer');
                serverInput.value = readerUrl;
                function openReader() { window.location.href = readerUrl; }
                function checkConnectivity() {
                  titleEl.textContent = 'Checking connection...';
                  bodyEl.textContent = '';
                  primaryBtn.textContent = 'Retry';
                  primaryBtn.onclick = function () { checkConnectivity(); };
                  fetch(readerUrl, { method: 'HEAD', mode: 'no-cors', cache: 'no-store' })
                    .then(function () { setOnline(); })
                    .catch(function () { setOffline(); });
                }
                function setOnline() {
                  titleEl.textContent = 'Opening your library...';
                  bodyEl.textContent = '';
                  primaryBtn.textContent = 'Open now';
                  primaryBtn.onclick = openReader;
                  setTimeout(openReader, 600);
                }
                function setOffline() {
                  titleEl.textContent = 'Internet required';
                  bodyEl.textContent = 'Connect to the internet to access your books.';
                  primaryBtn.textContent = 'Retry';
                  primaryBtn.onclick = function () { checkConnectivity(); };
                }
                secondaryBtn.onclick = function () {
                  serverPanel.style.display = serverPanel.style.display === 'flex' ? 'none' : 'flex';
                };
                saveBtn.onclick = function () {
                  var nextUrl = (serverInput.value || '').trim();
                  if (!nextUrl) return;
                  readerUrl = nextUrl;
                  try { localStorage.setItem(STORAGE_KEY, readerUrl); } catch (e) {}
                  serverPanel.style.display = 'none';
                  checkConnectivity();
                };
                window.addEventListener('online', function () { checkConnectivity(); });
                window.addEventListener('offline', function () { setOffline(); });
                checkConnectivity();
              })();
            </script>
          </body>
          </html>
          '@
          $indexContent | Out-File -FilePath out/index.html -Encoding utf8
          Write-Host "Static build complete in ./out"

      - name: Build Windows app
        run: npm run tauri build -- --config src-tauri/tauri.conf.json
        env:
          TAURI_SKIP_DEVSERVER_CHECK: true

      - name: List build output
        shell: pwsh
        run: |
          Get-ChildItem -Path src-tauri/target/release/bundle -Recurse -Include *.exe,*.msi | ForEach-Object { Write-Host $_.FullName }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.msi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.msi
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
